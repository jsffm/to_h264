#!/bin/bash

# to_h264						jsffm@web.de

# http://www.vdr-wiki.de/wiki/index.php/To_h264

# Funktioniert mit .vdr und .ts
#
# Ziel wird in .rec Ordner + 1 gespeichert
#
# Video wird nach h264 konvertiert
# Audio mp2 wird nach aac konvertiert
#	unter 160 kb/s --> 96 kb/s
#	bis 192 kb/s --> 128 kb/s
#	über 192 kb/s --> 192 kb/s
# AC3 wird kopiert
#
# Alle Tonspuren bleiben erhalten
#
# Untertitel werden kopert
#
# info.vdr wird ergänzt mit "L 99"
#
# Softhddevice spielt das Ergebnis klaglos ab
#
#	Unbedingt die FilmlÃ¤nge Ã¼berprÃ¼fen!
#
#	.vdr > 1 Datei und > 1 Audiospur mit procetx vorbehandeln
#
#	ToDo
#
#	info-Datei anpassen http://www.vdr-wiki.de/wiki/index.php/Info

# Schalter sind nach to_h264.conf verlagert, hier nichts Ã¤ndern!

#set -x

#mpeg2_q="-q 5"
mpeg2_q="-q 5 -maxrate 3000k -bufsize 1835k"
h264_profile=high
h264_level=3.0	# 720x576i
hevc_level=4.0
nvenc_b_HD="-b:v 5M"
hevcenc=libx265
hevcenc_b="-b:v 2M"
hevc_cq=21

#set -x
if [ -e /etc/to_h264.conf ]
then
    conf=/etc/to_h264.conf
fi
if [ -e $0.conf ]
then
    conf=$0.conf
fi
if [ "$conf" == "" ]
then
    wo=$(which to_h264)
    conf=$wo.conf
fi
if [ "$conf" == "" ]
then
    echo "conf-Datei fehlt."
    exit 8
fi
#exit

. $conf

logf=/tmp/h264-log
h264_k=h264
lock="h264.lck"

#join4=yes		# mplayer not working
#generate=yes	# for future use
#gen_name=doit	# for future use

#set -x

which ffmpeg 2> /dev/null
if [ $? -eq 0 ]
then
    ffmpeg=ffmpeg
    ffprobe=ffprobe
fi
which avconv 2> /dev/null
if [ $? -eq 0 ]
then
    ffmpeg=avconv
    ffprobe=avprobe
fi
which x/opt/ffmpegnv/bin/ffmpeg 2> /dev/null
if [ $? -eq 0 ]
then
    ffmpeg=/opt/ffmpegnv/bin/ffmpeg
    ffprobe=/opt/ffmpegnv/bin/ffprobe
fi

if [ "$h264enc" == "" ]
then
    h264enc=libx264
    if [ $ffmpeg == "/opt/ffmpegnv/bin/ffmpeg" ]
    then
	h264enc=h264_nvenc
    fi
    nv=$($ffmpeg 2>&1 | grep "enable-nvenc")
    if [ "$nv" != "" ]
    then
	h264enc=h264_nvenc
    fi
fi
#exit

aac_select() {
case $aac_br_select in
    1)
	aac_br1=96		# mp2 < 160
	aac_br2=128		# mp2
	aac_br3=192		# mp2 > 192
	;;
    2)
	aac_br1=72		# mp2 < 160
	aac_br2=96		# mp2
	aac_br3=128		# mp2 > 192
	;;
esac
}

if [ "$1" == "auto" ]
then
    if [ ! -e $h264_k ]
    then
	exit
    else
	. $h264_k
    fi
    if [ -e $lock ]
    then
	exit
    fi
fi
if [ "$splits" != "" ]
then
    split="-f segment -segment_start_number 1 -segment_time $splits"
fi

aac_select

t=/tmp/info
t2=/tmp/info2

if [ -e 00001.ts ]
then
    infile=00001.ts
    $ffmpeg -i $infile 2> $t
    fmt=ts
    w="*.ts"
    index=index
    info=info
    f=$(grep "^F" $info | cut -d ' ' -f 2)
fi
if [ -e 001.vdr ]
then
    infile=001.vdr
    #form="-f mpeg"
    $ffmpeg $form -i $infile 2> $t
    fmt=vdr
    w="0*.vdr"
    index=index.vdr
    info=info.vdr
    f=25
fi
if [ "$fmt" == "" ]
then
    echo "Falsche Directory?"
    exit
fi
#set -x
v=$(grep "ffmpeg version" $t)
#v=$(ffmpeg -version)
v=$(echo $v | cut -d \  -f 3)
#exit

for r in $w
do
    infiles="$infiles $r"
done
nfiles=$(echo $infiles | wc -w)

ac3_vorh=$(grep ac3 $t)

show_t() {
    #set -x
    while read line
    do
	typ=$(echo $line | cut -d ' ' -f 4)
	typ=${typ//,/}
	stream=$(echo $line | cut -d ' ' -f 2)
	stream=${stream:0:11}
	case $typ in
	    # Stream '#0:0[0x6e]:' Video: mpeg2video '(Main)' '([2][0][0][0]' / '0x0002),' 'yuv420p(tv),' 720x576 '[SAR' 64:45 DAR '16:9],' max. 15000 kb/s, 25 fps, 25 tbr, 90k tbn, 50 tbc
	    "mpeg2video" | "mpeg1video" | "h264" | "hevc")
		if [ "$fmt" == "vdr" ]
		then
		    iaufl=7
		    ir=11
		    if [ "$typ" == "mpeg1video" ]
		    then
			iaufl=6
			ir=10
		    fi
		else
		    if [ "$ffmpeg" != "avconv" ]
		    then
			iaufl=10
			ir=14
		    else
			iaufl=7
			ir=11
		    fi
		fi
		aufl=$(echo $line | cut -d ' ' -f $iaufl)
		r=$(echo $line | cut -d ' ' -f $ir)
		r=${r//],/}
		echo $stream $typ $aufl $r
		;;
	    "mp2" | "aac" | "ac3" | "eac3")
		if [ "$fmt" == "vdr" ]
		then
		    ityp=7
		    ibr=9
		else
		    if [ "$ffmpeg" != "avconv" ]
		    then
			ityp=10
			ibr=12
		    else
			ityp=7
			ibr=9
		    fi
		    lang=$(echo $line | cut -d ' ' -f 2 | cut -d "(" -f 2 | cut -d ")" -f 1)
		    if [ "${lang:0:1}" == "#" ]
		    then
			lang=""
		    fi
		fi
		atyp=$(echo $line | cut -d ' ' -f $ityp)
		atyp=${atyp//,/}
		br=$(echo $line | cut -d ' ' -f $ibr)
		echo $stream $lang $typ $atyp $br "kb/s"
		;;
	esac
    done < $t
}

#	Menue


cat $t
while (true) do
    #if [ "$v" "<" "1.1.0" -a "$join" == "ffmpeg" ]
    if [ "$v" "<" "1.1.0" ]
    then
	if [ "$join" == "ffmpeg" ]
	then
	    join=cat
	fi
	#if [ "$join" == "concat" ]
	#then
	#    join=cat
	#fi
	if [ "$join" == "tsmuxer" -a "$fmt" == "vdr" ]
	then
	    join=cat
	fi
    else
	if [ "$join" == "cat" ]
	then
	    join=ffmpeg
	fi
	#if [ "$join" == "tsmuxer" ]
	#then
	#    join=ffmpeg
	#fi
    fi
    if [ "$ffmpeg" == "avconv" ]
    then
	if [ "$join" == "ffmpeg" ]
	then
	    join=concat
	fi
    fi
    if [ $nfiles -eq 1 ]
    then
	case $join in
	    "ffmpeg" | "cat" | "tsmuxer" | "concat")
		join=no
		;;
	esac
    fi
    if [ "$join" == "projectx" ]
    then
	if [ "$mux" == "ffmpeg" ]
	then
	    demux_x264=no
	    demux_aac=no
	fi
    fi
    pwd
    #grep "Stream" $t
    # vdr
    # Stream #0:0[0x1e0]: Video: mpeg2video (Main), yuv420p, 720x576 [SAR 64:45 DAR 16:9], 15000 kb/s, 25 fps, 25 tbr, 90k tbn, 50 tbc
    # Stream #0:1[0x1c0]: Audio: mp2, 48000 Hz, stereo, s16, 192 kb/s
    # ts
    # Stream #0:0[0x231]: Video: mpeg2video (Main) ([2][0][0][0] / 0x0002), yuv420p, 704x576 [SAR 16:11 DAR 16:9], 15000 kb/s, 25 fps, 25 tbr, 90k tbn, 50 tbc
    # Stream #0:1[0x232](deu): Audio: mp2 ([4][0][0][0] / 0x0004), 48000 Hz, stereo, s16, 192 kb/s
    # Stream #0:0[0x100]: Video: h264 (Main) ([27][0][0][0] / 0x001B), yuv420p, 720x576 [SAR 64:45 DAR 16:9], 25 fps, 25 tbr, 90k tbn, 50 tbc
    # Stream #0:1[0x101]: Audio: aac ([15][0][0][0] / 0x000F), 48000 Hz, stereo, s16, 118 kb/s

    show_t
    echo "$ffmpeg Version $v"
    echo "Format=$fmt"
    echo "Anzahl Dateien: $nfiles"
    echo mkv=$mkv
    echo outf=$outf
    echo audio_auswahl=$audio_auswahl
    echo subtitle=$subtitle
    echo join=$join
    #echo join2=$join2
    #echo join3=$join3
    #echo projectxd=$projectxd
    if [ "$join" == "projectx" ]
    then
	echo demux_x264=$demux_x264
	echo demux_aac=$demux_aac
	echo mux=$mux
    fi
    echo gop=$gop
    echo mp2=$mp2
    echo aac_br_select=$aac_br_select $aac_br1,$aac_br2,$aac_br3
    echo ac3_stereo=$ac3_stereo
    if [ "$ac3" != "" ]
    then
	echo ac3=$ac3
    fi
    echo scale=$scale
    echo aspect=$aspect
    if [ "$vcodec" != "" ]
    then
	echo vcodec=$vcodec
    fi
    if [ "$odir" != "" ]
    then
	echo odir=$odir
    fi
    if [ -e $h264_k ]
    then
	if [ -e $lock ]
	then
	    exit
	fi
	. $h264_k
	stop=no
	touch $lock
    fi
    if [ "$stop" == "yes" ]
    then
	echo "press Enter (a1,a2,p,c,n,o,a,m,sc,s3,aa,gnn,mpg,mc,?)"
	read answer
	#echo "[$answer]"
	case $answer in
	    "")
		break
		;;
	    "p")
		join=projectx
		;;
	    "c")
		join=cat
		;;
	    "t")
		join=tsmuxer
		;;
	    "f")
		join=ffmpeg
		;;
	    "n")
		join=no
		;;
	    "o")
		join=concat
		;;
	    "a")
		if [ "$audio_auswahl" == "yes" ]
		then
		    audio_auswahl=no
		else
		    audio_auswahl=yes
		fi
		;;
	    "m")
		if [ "$mkv" == "yes" ]
		then
		    mkv=no
		else
		    mkv=yes
		fi
		;;
	    "mp4")
		if [ "$outf" == "mp4" ]
		then
		    outf=""
		else
		    outf="mp4"
		fi
		;;
	    "s3")
		if [ "$ac3_stereo" == "ac3" ]
		then
		    ac3_stereo=no
		else
		    ac3_stereo=ac3
		fi
		;;
	    "sc")
		if [ "$ac3_stereo" == "aac" ]
		then
		    ac3_stereo=no
		else
		    ac3_stereo=aac
		fi
		;;
	    "aa")
		ac3=aac
		;;
	    "mpg")
		vcodec=mpeg2video
		mp2=copy
		;;
	    "mc")
		mp2=copy
		;;
	    "hevc"|"h")
		vcodec=hevc
		;;
	    "oly")
		mkv=yes
		ac3=aac
		;;
	    "?")
		echo "a audio_auswahl"
		echo "a1,a2 aac_br_select"
		echo "c cat"
		echo "f ffmpeg"
		echo "gnn gop=\"-g nn\""
		echo "m mkv"
		echo "mp4 mp4"
		echo "mc mp2=copy"
		echo "n no"
		echo "o concat"
		echo "p projectx"
		echo "s3 ac3_stereo=ac3"
		echo "sc ac3_stereo=aac"
		echo "aa ac3=aac"
		echo "t tsmuxer"
		;;
	    *)
		if [ "${answer:0:1}" == "a" -a ${#answer} -gt 1 ]
		then
		    aac_br_select=${answer:1}
		    aac_select
		fi
		if [ "${answer:0:1}" == "g" ]
		then
		    gop="-g ${answer:1}"
		fi
		;;
	esac
    else
	break
    fi
done

log=/tmp/h264_log
rm -f $log
touch $log
if [ "$fmt" == "vdr" -a $nfiles -gt 1 ]
then
    for r in $w
    do
	echo $r >> $log
	$ffmpeg -i $r 2> $t
	grep "Stream" $t >> $log
    done
    cat $log
    if [ "$stop" == "yes" -a "$join" != "projectx" ]
    then
	echo "p = projectx"
	echo -e "press Enter"
	read answer
    if [ "$answer" == "p" ]
    then
	join=projectx
    fi
    fi
fi

start=$(date +"%s")

#set -x
# 2010-01-28.23.16.50.99.rec
# 2011-12-19.20.16.10-0.rec
d=$(basename $PWD)
#d1=$(echo $d | cut -d '.' -f 1-2)
#d2=$(echo $d | cut -d '.' -f 3)
#d1=${d:0:13}
#d2=${d:14:2}
#if [ "${d2:0:1}" == "0" ]
#then
#    d2=${d2:1:1}
#fi
#d2=$(($d2+1))
#if [ ${#d2} == 1 ]
#then
#    d2=0$d2
#fi
#set -x
dd1=${d:0:10}
dd=${d:0:16}
dh=${d:11:2}
dm=${d:14:2}
rec_time=$(date "+%s" -d "$dd1 $dh:$dm")
#s=$(($s+60))
#dd2=$(date -u "+%F.%H.%M" -d @$s)
d3=$(echo $d | cut -d '.' -f 4-)
if [ "$fmt" == "vdr" ]
then
    #dest=$(echo $dest | cut -d '.' -f 1-3)."1-0.rec"
    d3="1-0.rec"
fi
#dest=$d1.$d2.$d3
#dest=$dd2.$d3
dest=$dd.$d3
d30=$(echo $d3|cut -d '.' -f 1)
d31=$(echo $d30|cut -d '-' -f 1)
d32=$(echo $d30|cut -d '-' -f 2)
while [ -e ../$dest ]
do
    d32=$(($d32+1))
    #dd2=$(date -u "+%F.%H.%M" -d @$s)
    #dest=$dd2.$d31-$d32.rec
    dest=$dd.$d31-$d32.rec
done
#exit

kennf=/tmp/kennf
rm -f $kennf
auswahl_hilfe=/tmp/auswahl_hilfe
rm -f $auswahl_hilfe
touch $auswahl_hilfe
#if [ "$fmt" == "vdr" ]
#then
    #dest=$(echo $dest | cut -d '.' -f 1-3)."1-0.rec"
    #dest=$(echo $dest | cut -d '.' -f 1-3)."$d31-$d32.rec"
#fi
#exit

while read line
do
    if [ "${line:0:1}" == "E" ]
    then
	rec_start_s=$(echo $line | cut -d \  -f 3)
    fi
done < $info
#s2=$(($rec_start_s+60))
#d=$(date +%F.%H.%M -d @$s2)
#dest=$d."1-0.rec"
#exit

if [ "$mkv" == "yes" ]
then
    outf=mkv
fi
if [ "$outf" != "" ]
then
    dest="."
    if [ "$odir" != "" ]
    then
	dest="$odir"
	mkdir -p $odir
    fi
    #subtitle=no
    # Chapter
    if [ -e marks ]
    then
	#set -x
	meta=ffmetadata
	echo ";FFMETADATA1" > $meta
	s1=0
	ca=0
	tag=$(date -u +"%s" -d 0:00:00)
	# 0:10:03.48
	while read line
	do
	    #echo $line
	    c=$(date -u +"%s" -d $line)
	    cs=$(echo $line|cut -d '.' -f 2)
	    ms=$(($cs*10))
	    c=$(($c-$tag))
	    c=$(($c*1000))
	    c=$(($c+$ms))
	    echo "[CHAPTER]" >> $meta
	    #echo "TIMEBASE=1" >> $meta
	    echo "TIMEBASE=1/1000" >> $meta
	    echo "START=$ca" >> $meta
	    echo "#chapter ends at $line" >> $meta
	    echo "END=$(($c-1))" >> $meta
	    if [ $s1 -eq 0 ]
	    then
		echo "title=Werbung $line" >> $meta
		s1=1
	    else
		echo "title=Film $line" >> $meta
		s1=0
	    fi
	    ca=$c
	done < marks
	metaf="-i ffmetadata"
	#exit
    else
	#nix(){
	#set -x
	meta=ffmetadata
	echo ";FFMETADATA1" > $meta
	dmin=10
	dms=$(($dmin*60*1000))
	si=$(ls -l $index)
	si=$(echo $si | cut -d ' ' -f 5)
	if [ "$f" == "50" ]
	then
	    si=$(($si/2))
	fi
	ds=$(($si/200))
	sms=$(($ds*1000))
	ca=0
	for (( c=$dms ; c<=$sms ; c+=$dms ))
	do
	    echo "[CHAPTER]" >> $meta
	    #echo "TIMEBASE=1" >> $meta
	    echo "TIMEBASE=1/1000" >> $meta
	    echo "START=$ca" >> $meta
	    #echo "#chapter ends at $line" >> $meta
	    #echo "END=$(($c-1))" >> $meta
	    echo "END=$c" >> $meta
	    ca=$c
	done
	metaf="-i ffmetadata"
	#exit
	#}
    fi
fi

#set -x
#cat $t
#if [ "$join2" == "yes" ]
if [ "$join" == "cat" ]
then
    if [ "$fmt" == "vdr" ]
    then
	filej2=filej2.vdr
    fi
    if [ "$fmt" == "ts" ]
    then
	filej2=filej2.ts
    fi
    #join=no
    if [ "$join2m" == "yes" ]
    then
	subtitle=no
    fi
    rm -f $filej2
fi
#exit

wlog () {

    d=`date +"%F %T"`
    echo $d $1 >> $log
}

if [ -e ../$dest -a "$dest" != "."  ]
then
    echo "Verzeichnis ../$dest schon vorhanden"
    if [ "$stop" == "yes" ]
    then
	echo "weitermachen? [j|n]"
	read answer
	if [ "$answer" == "n" ]
	then
	    exit
	fi
    else
	exit
    fi
else
    if [ "$odir" == "" ]
    then
	mkdir ../$dest
    fi
fi
logt=$log
log="../$dest/logfile"
if [ "$odir" != "" ]
then
    log=$odir/logfile
fi
d=`date +"%F %T"`
echo "Start $d" $(hostname) > $log
#echo $(hostname) >> $log
uname -p >> $log
echo $PWD >> $log
echo $PWD >> /tmp/h264_current
echo $d $PWD >> /var/log/h264
echo "gop=$gop" >> $log
echo "mkv=$mkv" >> $log
echo "audio_auswahl=$audio_auswahl" >> $log
echo "subtitle=$subtitle" >> $log
echo "join=$join" >> $log
#echo "join2=$join2" >> $log
#if [ "$join3" != "" ]
if [ "$join" == "projectx" ]
then
    #echo "join3=$join3" >> $log
    echo demux_x264=$demux_x264 >> $log
    echo demux_aac=$demux_aac >> $log
    echo mux=$mux >> $log
fi
echo mp2=$mp2 >> $log
echo aac_br_select=$aac_br_select $aac_br1,$aac_br2,$aac_br3 >> $log
if [ "$mp2_256" != "" ]
then
    echo mp2_256=$mp2_256 >> $log
fi
if [ "$mp2_256_no_ac3" != "" ]
then
    echo "mp2_256_no_ac3=$mp2_256_no_ac3" >> $log
fi
if [ "$ac3_stereo" != "" ]
then
    echo ac3_stereo=$ac3_stereo >> $log
fi
if [ "$ac3" != "" ]
then
    echo ac3=$ac3 >> $log
fi
#echo "h264_level=$h264_level" >> $log
echo "h264=$h264" >> $log
echo "h264enc=$h264enc" >> $log
#echo "maxrate=$maxrate" >> $log
echo "scale=$scale" >> $log
echo "aspect=$aspect" >> $log
#echo "preset=$preset" >> $log
echo vcodec=$vcodec >> $log
#set -x
which mediainfo 2> /dev/null
if [ $? -eq 0 ]
then
    scantype=$(mediainfo --Inform="Video;%ScanType/String%" "$infile")
    echo "scantype=$scantype" >> $log
fi
if [ "$split" != "" ]
then
    echo "split=$split" >> $log
fi
if [ "$scantype" == "Progressive" ]
then
    deinterlace=
else
    opt_r="-r 50"
fi
echo "deinterlace=$deinterlace" >> $log
#exit
    
ls -lLk >> $log

si=$(ls -l $index)
si=$(echo $si | cut -d ' ' -f 5)
if [ "$f" == "50" ]
then
    si=$(($si/2))
fi
s=$(($si/200))
date -u -d @$s "+%T" >> $log

size1=$(du -L)
size1=$(echo $size1 | cut -d ' ' -f 1)
cat $logt >> $log
rm $logt

d2=$(dirname $PWD)
title=$(basename $d2)
if [ "$title" == "_" ]
then
    d2=$(dirname $d2)
    title=$(basename $d2)
fi
if [ ${title:0:1} == "%" ]
then
      title=${title:1}
fi
if [ "$fname" != "" ]
then
    title=$fname
fi
#exit

#info=$(ffmpeg -i 00001.ts | grep "Stream" | grep "Audio")
#cp $t $log
cat $t >> $log

aac_br() {
    br=$aac_br2
    if [ $1 -gt 192 ]
    then
	br=$aac_br3
    fi
    if [ $1 -lt 160 ]
    then
	br=$aac_br1
    fi
}

set_h264_nvenc()
{
    #preset="-profile:v $h264_profile -b:v 1500k -crf $crf"
    nvenc_b=
    #preset="-preset hq -profile:v $h264_profile $level -cq $crf $nvenc_b $maxr $opt_r"
    preset="-preset hq -profile:v $h264_profile $level -cq $crf $nvenc_b $maxr"
    lspci | grep VGA >> $log
    grep "NVIDIA GPU " /var/log/Xorg.0.log >> $log
}

set_libx264()
{
    preset="-preset fast -tune film -profile:v $h264_profile $level -crf $crf $maxr"
    if [ $h264enc == "libx264" ]
    then
	preset="$preset $x264opts"
    fi
}

set_hevc() {
    crf=28
    if [ "$maxrate" != "no" ]
    then
	maxr="-maxrate "$br"k -bufsize 1835k"
    fi
    #preset="-preset fast -tune film -profile:v main $level -crf $crf -maxrate "$br"k -bufsize 1835k"
    preset="-preset veryfast $level_hevc -crf $crf $maxr"
    if [ "$hevcenc" == "hevc_nvenc" ]
    then
	#preset="-preset hq $level $hevcenc_b"
	#preset="-preset hq $level_hevc -cq 21"
	#preset="-preset hq $level_hevc -rc constqp -b 2M"
	#preset="-preset hq $level_hevc -rc constqp -cq 21 -strict_gop 1 -forced-idr 1 -r 50"
	#preset="-preset hq $level_hevc -rc constqp -cq 21 -strict_gop 1 -forced-idr 1"
	#preset="-preset hq $level_hevc -rc constqp -cq 21 -strict_gop 1 -forced-idr 1 -r 50 -bluray-compat 1"
	#preset="-preset hq $level_hevc -rc vbr -cq 21 -r 50"
	preset="-preset hq $level_hevc -rc vbr -cq $hevc_cq $opt_r"
	lspci | grep VGA >> $log
	grep "NVIDIA GPU " /var/log/Xorg.0.log >> $log
    fi
    preset="$preset $gop"
    video="-c:v $hevcenc $preset $deinterlace $scale $aspect"
    if [ "$videof" == "hevc" -a "$scale" == "" ]
    then
	video="-c:v copy"
    fi
}

file_check() {


$ffmpeg -i $1 2> $t

dur=$(grep "Duration:" $t)
#echo $dur
for i in $dur
    do
        #echo $i
        if [ "$i" == "kb/s" ]
        then
        break
    fi
    brv=$i
done
#echo $brv
#exit


#info=$(cat $t | grep "Stream" | grep "Audio")
grep "Stream" $t | grep "Audio" > $t2
#cat $t2

# Stream #0:1[0x25a](deu): Audio: mp2 ([3][0][0][0] / 0x0003), 48000 Hz, stereo, s16, 192 kb/s (clean effects)
# Stream #0:2[0x25b](2ch): Audio: mp2 ([3][0][0][0] / 0x0003), 48000 Hz, stereo, s16, 192 kb/s (clean effects)
# Stream #0:1[0x1c0]: Audio: mp2, 48000 Hz, stereo, s16, 192 kb/s
# Stream #0:2[0x102](deu): Audio: ac3 ([129][0][0][0] / 0x0081), 48000 Hz, stereo, s16, 448 kb/s
# Stream #0:2[0x1101](deu): Audio: ac3 (AC-3 / 0x332D4341), 48000 Hz, stereo, s16, 448 kb/s
# Stream #0:2[0x1101](deu): Audio: ac3 (AC-3 / 0x332D4341)  48000 Hz  stereo  s16  448 kb/s
# Stream #0:1[0xca](deu): Audio: aac_latm (LC) ([17][0][0][0] / 0x0011), 48000 Hz, 5.1, fltp

# ffmpeg -i INPUT -metadata:s:a:1 language=eng OUTPUT

map="-map 0:v:0"

declare -a au
declare -a ac
declare -a ab
declare -a am
declare -a aach
declare -a aaf
audio=""
rm -f $kennf
bras=0
ostream=0
while read line
do
    #set -x
    echo $line
    if [ "$ffmpeg" != "avconv" ]
    then
	del1=":"
    else
	del1="."
    fi
    stream1=$(echo $line | cut -d ' ' -f 2 | cut -d $del1 -f 2 | cut -d '[' -f 1)
    stream=$(($stream1-1))
    codec=$(echo $line | cut -d ' ' -f 4)
    codec=${codec//,/}
    lang=$(echo $line | cut -d ' ' -f 2 | cut -d \( -f 2 | cut -d \) -f 1)
    if [ "${lang:0:1}" == "#" ]
    then
	lang=""
    fi
    for i in $line
    do
	#echo $i
	if [ "$i" == "kb/s" ]
	then
	    break
	fi
	bra=$i
    done
    #if [ "x" == "xx" ]
    #then
    #f2=$(echo $line | cut -d ' ' -f 2)
    #x1=$(expr index "$f2" "(")
    #if [ "$x1" != "" ]
    #then
	#x2=$(expr index "$f2" ")")
	#lang=${f2:$(($x1+1)):$(($x2-$x1-1))}
    #else
	#lang=""
    #fi
    #fi
    #set -x
    kenn=$(echo $line | cut -d ' ' -f 2 | cut -d '[' -f 2 | cut -d ']' -f 1)
    kenn=$(($kenn))
    #set +x
    #exit
    br=""
    ch=""
    ame=""
    case "$codec" in
	"mp2")
	    line2=${line//,/}
	    atyp1=${line2#*Hz*}
	    atyp=$(echo $atyp1 | cut -d ' ' -f 1)
	    atyp=${atyp//,/}
	    #if [ "$atyp" == "stereo" ]
	    a="-c:a:$ostream copy"
	    c=copy
	    if [ "$mp2" == "aac" ]
	    then
		aac_br $bra
		a="-c:a:$ostream $aaclib -b:a:$ostream "$br"k"
		c=$aaclib
		ame=" -streamid $stream1:$stream1"
		if [ "$atyp" == "monox" ]
		then
		    #set -x
		    br=$(($br/2))
		    if [ $br -lt 48 ]
		    then
			br=48
		    fi
		    a="-c:a:$ostream $aaclib -b:a:$ostream "$br"k -ac:a:$ostream 1"
		    #c="$aaclib -ac:a:$ostream 1"
		    c="$aaclib"
		    ch=1
		    #exit
		fi
	    fi
	    if [ "$mp2_256" == "ac3" -a $bra -ge 256 ]
	    then
		br=192
		a="-c:a:$ostream ac3 -ac:a:$ostream 2 -b:a:$ostream "$br"k"
		#c="ac3 -ac 2"
		c="ac3"
		ch=2
		kenn=$(($kenn+100))
	    fi
	    if [ "$mp2_256_no_ac3" == "ac3" -a $bra -ge 256 -a "$ac3_vorh" == "" ]
	    then
		br=192
		a="-c:a:$ostream ac3 -ac:a:$ostream 2 -b:a:$ostream "$br"k"
		#c="ac3 -ac 2"
		c="ac3"
		ch=2
		kenn=$(($kenn+100))
	    fi
	    if [ "$mp2" == "ac3-6" ]
	    then
		br=448
		a="-c:a:$ostream ac3 -ac:a:$ostream 6 -b:a:$ostream "$br"k"
		#c="ac3 -ac 6"
		c="ac3"
		ch=6
		kenn=$(($kenn+100))
	    fi
	    ;;
	"mp3")
	    #set -x
	    if [ "$mp3" == "no" ]
	    then
		#continue
		a=""
		c=""
	    else
		a="-c:a:$stream copy"
		c=copy
	    fi
	    ;;
	"aac"|"aac_latm")
	    # Stream #0:1[0xca](deu): Audio: aac_latm (LC) ([17][0][0][0] / 0x0011), 48000 Hz, 5.1, fltp
	    line2=${line//,/}
	    atyp1=${line2#*Hz*}
	    atyp=$(echo $atyp1 | cut -d ' ' -f 1)
	    atyp=${atyp//,/}
	    a="-c:a:$stream copy"
	    if [ "$outf" == "mp4" -a "$codec" == "aac" ]
	    then
		a="$a -bsf:a aac_adtstoasc"
	    fi
	    if [ "$outf" == "mp4" -a "$codec" == "aac_latm" ]
	    then
		aac=aac
	    fi
	    c=copy
	    if [ "$vcodec" == "mpeg2video" ]
	    then
		br=192
		a="-c:a:$ostream mp2 -b:a:$ostream "$br"k"
		#c="mp2 -b 192k"
		#c="mp2"
		c="libtwolame"
	    fi
	    if [ "$aac" == "aac" ]
	    then
		aac_br 192
		a="-c:a:$ostream $aaclib -b:a:$ostream "$br"k"
		c=$aaclib
	    fi
	    if [ "$atyp" != "stereo" ]
	    then
		echo $codec $atyp >> $log
		br=256
		a="-c:a:$ostream eac3 -b:a:$ostream "$br"k"
		c=eac3
		#br=448
		#a="-c:a:$ostream ac3 -b:a:$ostream "$br"k"
		#c=ac3
	    fi
	    if [ "$aac" == "ac3-6" ]
	    then
		br=448
		a="-c:a:$ostream ac3 -ac:a:$ostream 6 -b:a:$ostream "$br"k"
		c="ac3"
		#br=256
		#a="-c:a:$ostream eac3 -ac:a:$ostream 6 -b:a:$ostream "$br"k"
		#c="eac3"
		ch=6
		#kenn=$(($kenn+100))
	    fi
	    ;;
	"eac3")
	    if [ "$eac3" == "" -o "$eac3" == "copy" ]
	    then
		a="-c:a:$ostream copy"
		c=copy
		kenn=$(($kenn+100))
		map="$map -streamid $stream1:0x84"
		aid=$((0x80+$stream1))
		ame=" -streamid $stream1:$aid"
	    fi
	    if [ "$eac3" == "aac" ]
	    then
		#set -x
		# Stream #0:1[0x101](deu): Audio: eac3 ([135][0][0][0] / 0x0087), 48000 Hz, 5.1(side), fltp, 256 kb/s
		line2=${line//,/}
		atyp1=${line2#*Hz*}
		atyp=$(echo $atyp1 | cut -d ' ' -f 1)
		atyp=${atyp//,/}
		if [ "$atyp" == "stereo" ]
		then
		    aac_br 192
		    a="-c:a:$ostream $aaclib -b:a:$ostream "$br"k"
		    c=$aaclib
		else
		    br=448
		    #a="-c:a:$ostream ac3 -ac:a:$ostream 2 -b:a:$ostream "$br"k"
		    a="-c:a:$ostream ac3 -b:a:$ostream "$br"k"
		    c="ac3"
		fi
		#exit
	    fi
	    if [ "$eac3" == "ac3" ]
	    then
		br=448
		a="-c:a:$ostream ac3 -b:a:$ostream "$br"k"
		c=ac3
	    fi
	    ;;
	"ac3")
	    a="-c:a:$ostream copy"
	    c=copy
	    #ame=" -streamid $stream1:0x84"
	    aid=$((0x80+$stream1))
	    ame=" -streamid $stream1:$aid"
	    #if [ "$fmt" == "vdr" ]
	    #then
		#ityp=7
	    #else
		#ityp=10
	    #fi
	    #atyp=$(echo $line | cut -d ' ' -f $ityp)
	    line2=${line//,/}
	    atyp1=${line2#*Hz*}
	    atyp=$(echo $atyp1 | cut -d ' ' -f 1)
	    atyp=${atyp//,/}
	    if [ "$atyp" == "stereo" ]
	    then
		case $ac3_stereo in
		    "aac")
			#br=192
			br=128
			a="-c:a:$ostream $aaclib -ac:a:$ostream 2 -b:a:$ostream "$br"k"
			#c="$aaclib -ac 2"
			c="$aaclib"
			ch=2
			;;
		    "ac3")
			if [ $bra -gt 192 ]
			then
			    br=192
			    a="-c:a:$ostream ac3 -ac:a:$ostream 2 -b:a:$ostream "$br"k"
			    #c="ac3 -ac 2"
			    c="ac3"
			    ch=2
			fi
			;;
		    "ac3-6")
			if [ $bra -gt 192 ]
			then
			    br=448
			    a="-c:a:$ostream ac3 -ac:a:$ostream 6 -b:a:$ostream "$br"k"
			    #c="ac3 -ac 6"
			    c="ac3"
			    ch=6
			fi
			;;
		esac
	    fi
	    if [ "$ac3" == "mp2+ac3" ]
	    then
		br=192
		#a="-c:a:$ostream libtwolame -b:a:$ostream "$br"k -ac:a:$ostream 2 -af:a:$ostream aresample=matrix_encoding=dplii:lfe_mix_level=2"
		a="-c:a:$ostream libtwolame -b:a:$ostream "$br"k -ac:a:$ostream 2"
		#c="mp2"
		c="libtwolame"
		#ch=2
		au[$ostream]=$a
		ac[$ostream]=$c
		ab[$ostream]=$br"k"
		#aach[$ostream]=$ch
		aaf[$ostream]="aresample=matrix_encoding=dplii:lfe_mix_level=2"
		am[$ostream]="-map 0:$stream1"
		ostream=$(($ostream+1))
		br=""
		ch=""
	        #a="$a -c:a:$stream1 copy"
	        a="$a -c:a:$ostream copy"
		c=copy
	        map="$map -map 0:a:$stream"
		kenn1=$(printf "%05d" $kenn)
		echo "$kenn1" $(($stream+1)) >> $kennf
	    fi
	    if [ "$ac3" == "ac3+eac3" ]
	    then
		#a="-c:a:$ostream mp2 -b:a:$ostream "$br"k -ac:a:$ostream 2"
	        a="-c:a:$ostream copy"
		c="copy"
		au[$ostream]=$a
		ac[$ostream]=$c
		#ab[$ostream]=$br"k"
	        #am[$ostream]="-map 0:a:$stream"
		am[$ostream]="-map 0:$stream1"
		ostream=$(($ostream+1))
		br=256
	        #a="$a -c:a:$stream1 copy"
		#a="$a -c:a:$ostream eac3 -b:a:$ostream "$br"k"
		a="$a -c:a:$ostream eac3 -b:a:$ostream "$br"k"
		#a="$a -dialnorm -31"
		c=eac3
	        map="$map -map 0:a:$stream"
		kenn1=$(printf "%05d" $kenn)
		echo "$kenn1" $(($stream+1)) >> $kennf
	    fi
	    if [ "$ac3" == "eac3" -a "$atyp" != "stereo" ]
	    then
		br=256
		a="-c:a:$ostream eac3 -b:a:$ostream "$br"k"
		#c=eac3
		c="eac3 -channel_coupling 0"
		ch=6
	    fi
	    if [ "$ac3" == "mp2" ]
	    then
		br=192
		#a="-c:a:$ostream mp2 -b:a:$ostream "$br"k -ac:a:$ostream 2 -af:a:$ostream aresample=matrix_encoding=dplii:lfe_mix_level=2"
		a="-c:a:$ostream libtwolame -b:a:$ostream "$br"k -af:a:$ostream aresample=matrix_encoding=dplii:lfe_mix_level=2"
		#c="mp2"
		c="libtwolame"
		#ch=2
		af="aresample=matrix_encoding=dplii:lfe_mix_level=2"
	    fi
	    if [ "$ac3" == "aac" ]
	    then
		br=192
		a="-c:a:$ostream $aaclib -b:a:$ostream "$br"k -ac:a:$ostream 2 -af:$ostream aresample=matrix_encoding=dplii:lfe_mix_level=2"
		#c="$aaclib -ac 2"
		c="$aaclib"
		ch=2
		af="aresample=matrix_encoding=dplii:lfe_mix_level=2"
	    fi
	    #set -x
	    kenn=$(($kenn+100))
	    #exit
	    ;;
	dts)
	    ;;
	*)
	    echo "$codec not valid!"
	    exit
	    ;;
    esac
    #if [ "$codec" == "mp3" -and "$mp3" == "no" ]
    #then
	#continue
    #fi
    if [ "$a" != "" ]
    then
	map="$map -map 0:$stream1"
	#map="$map -map 0:a:$stream"
	audio="$audio $a"
	kenn=$(printf "%05d" $kenn)
	echo "$kenn $stream" >> $kennf
    fi
#set -x
    if [ "$lang" != "" ]
    then
	if [ "$v" ">" "1.2.0" ]
	then
	    l="-metadata:s:a:$stream language=$lang"
	    audio="$audio $l"
	    al[$ostream]=$l
	fi
    fi
    #echo stream=$stream
    if [ "$a" != "" ]
    then
	au[$ostream]=$a
	ac[$ostream]=$c
	am[$ostream]="-map 0:$stream1"
	#am[$ostream]="-map 0:$stream1 $ame"
	if [ "$br" != "" ]
	then
	    ab[$ostream]=$br"k"
	fi
	if [ "$ch" != "" ]
	then
	    aach[$ostream]=$ch
	fi
	if [ "$af" != "" ]
	then
	    aaf[$ostream]=$af
	fi
	aline[$ostream]=$line
	bras=$(($bras+$bra))
	ostream=$(($ostream+1))
    fi
done < $t2
#exit
brv=$(($brv-$bras))
echo "Videobitrate: $brv" >> $log
br=$(($brv/2))
if [ "$h264" == "h264" ]
then
    br=$brv
fi
if [ $br -gt 2000 ]
then
    br=2000
fi
#preset="-preset fast -tune film -profile:v main -level 4.0 -crf $crf -maxrate "$br"k -bufsize 1835k"

# Scan nach "[SAR" hw

#set -x
videof=$(cat $t | grep "Video:")
hw=${videof%%[SAR*}
nw=$(echo $hw|wc -w)
hw=$(echo $hw|cut -d \  -f $nw)
vw=$(echo $hw|cut -d 'x' -f 2)
hw=$(echo $hw|cut -d 'x' -f 1)
videof=$(echo $videof | cut -d ' ' -f 4)
if [ "$scale" != "" ]
then
    hws=$hw
    hw1=${scale##*scale=}
    hw=$(echo $hw1|cut -d ':' -f 1)
    if [ "$hw" == "iw" ]
    then
	hw=$hws
    fi
fi
if [ $hw -gt 720 ]
then
    h264_level=4.2
    hevc_level=4.1
    maxrate=no
    #nvenc_b="-b:v 3M"
    #nvenc_b="-b:v 5M"
    nvenc_b=$nvenc_b_HD
fi
if [ $hw -gt 1280 ]
then
    h264_level=4.2
    hevc_level=4.1
fi
#exit
if [ "$ffmpeg" != "avconv" ]
then
    level="-level $h264_level"
    level_hevc="-level $hevc_level"
#else
    #level="-x264-params level=40"
fi
echo "h264_level=$h264_level" >> $log
echo "maxrate=$maxrate" >> $log

if [ "$maxrate" != "no" ]
then
    maxr="-maxrate "$br"k -bufsize 1835k"
fi

if [ "$hwaccel" == "cuvid" ]
then
    #set -x
    echo hwaccel=$hwaccel >> $log
    case $videof in
	hevc)
	    #gopt="$gopt -hwaccel cuvid -c:v hevc_cuvid"
	    gopt="$gopt -c:v hevc_cuvid"
	    ;;
	h264)
	    #gopt="$gopt -hwaccel cuvid -c:v h264_cuvid"
	    gopt="$gopt -c:v h264_cuvid"
	    ;;
	mpeg2video)
	    #gopt="$gopt -hwaccel cuvid -c:v mpeg2_cuvid"
	    gopt="$gopt -c:v mpeg2_cuvid"
	    ;;
    esac
    #exit
fi

set_libx264
if [ "$videof" == "hevc" ]
then
    #preset="-preset fast -tune film -profile:v main $level -crf $crf -maxrate "$br"k -bufsize 1835k"
    preset="-preset fast -tune film -profile:v $h264_profile $level -crf $crf"
    #preset="$preset $gop"
    maxr=
    deinterlace=
fi
if [ $h264enc == "h264_nvenc" ]
then
    set_h264_nvenc
fi
preset="$preset $gop"

# Stream #0:0[0xad]: Video: mpeg2video (Main) ([2][0][0][0] / 0x0002), yuv420p, 720x576 [SAR 16:15 DAR 4:3], 15000 kb/s, 25 fps, 25 tbr, 90k tbn, 50 tbc
# Stream #0:0[0x100]: Video: h264 (Main) ([27][0][0][0] / 0x001B), yuv420p, 720x576 [SAR 64:45 DAR 16:9], 25 fps, 25 tbr, 90k tbn, 50 tbc


video="-c:v $h264enc $preset $deinterlace $scale $aspect"
#video="-c:v libx264 $preset $scale"
if [ "$videof" == "hevc" ]
then
    if [ "$hevc" == "copy" ]
    then
	vcodec=hevc
    fi
fi
if [ "$vcodec" == "" ]
then
    vcodec=H264
fi

if [ "$vcodec" == "mpeg2video" ]
then
    #mpeg2_br=3000k
    #mpeg2_br=2500k
    #preset="-preset fast -tune film -crf 21 -b $mpeg2_br"
    #preset="-preset fast -tune film -crf 21 -maxrate 3000k -bufsize 1835k"
    #preset="-preset fast -tune film $mpeg2_q"
    preset="$mpeg2_q"
    preset="$preset $gop"
    video="-c:v mpeg2video $preset $deinterlace $scale"
    mp2=copy
fi


if [ "$vcodec" == "hevc" ]
then
    set_hevc
fi


if [ "$scale" == "" ]
then

if [ "$videof" == "h264" ]
then
    echo "Video schon in h264?"
    #exit
    #if [ "$vcodec" != "mpeg2video" ]
    if [ "$vcodec" == "H264" ]
    then
	video="-c:v copy"
	if [ "$h264" == "h264" ]
	then
	    #preset="-preset fast -tune film -profile:v $h264_profile $level -crf $crf"
	    set_libx264
	    if [ $h264enc == "h264_nvenc" ]
	    then
	        #preset="-preset hq -profile:v $h264_profile $level -crf $crf $nvenc_b $maxr"
	        set_h264_nvenc
	    fi
	    preset="$preset $gop"
	    video="-c:v $h264enc $preset $deinterlace $scale $aspect"
	fi
    fi
fi

fi
echo "preset=$preset" >> $log

#cat $t

#echo "stream=$stream"
if [ $stream -gt 0 ]
then

if [ "$audio_auswahl" == "yes" ]
then
    cat $t
    cat $auswahl_hilfe
    show_t
    echo "map:" $map
    echo "audio:" $audio
    #echo "video:" $video
    echo "Reihenfolge der Audiostreams Ã¼berprÃ¼fen"
    echo "Ãnderung z.B. 2,1"
    echo "n = Abbruch"
    echo "a = autom."
    read answer
    if [ "$answer" == "n" ]
    then
	exit
    fi
else
    answer=a
fi
    if [ "$answer" == "a" ]
    then
	#answer=""
	audio=""
	map="-map 0:v:0"
	sort < $kennf > $t2
	#cat $t2
	is=0
	while read line
	do
	    s=$(echo $line | cut -d \  -f 2)
	    if [ "${ac[$s]}" == "" ]
	    then
		continue
	    fi
	    audio="$audio -c:a:$is ${ac[$s]}"
	    #audio="$audio ${au[$s]}"
	    if [ "${ab[$s]}" != "" ]
	    then
		audio="$audio -b:a:$is ${ab[$s]}"
	    fi
	    if [ "${aach[$s]}" != "" ]
	    then
		audio="$audio -ac:a:$is ${aach[$s]}"
	    fi
	    if [ "${aaf[$s]}" != "" ]
	    then
		#audio="$audio -af:a:$is ${aaf[$s]}"
		#audio="$audio -af:$is ${aaf[$s]}"
		audio="$audio -af ${aaf[$s]}"
	    fi
	    lang=${al[$s]}
	    if [ "$lang" != "" ]
	    then
		if [ "$v" ">" "1.2.0" ]
		then
		    #l="-metadata:s:a:$is language=$lang"
		    audio="$audio $lang"
		fi
	    fi
	    #map="$map -map 0:a:$(($s))"
	    map="$map ${am[$s]}"
	    is=$(($is+1))
	    echo ${aline[$s]}
	done < $t2
    if [ "$audio_auswahl" == "yes" ]
    then
	echo "map:" $map
	echo "audio:" $audio
	echo "Reihenfolge der Audiostreams Ã¼berprÃ¼fen"
	echo "Ãnderung z.B. 2,1"
	echo "n = Abbruch"
	read answer
	if [ "$answer" == "n" ]
	then
	    exit
	fi
    else
	answer=""
    fi
    fi
    if [ "$answer" != "" ]
    then
	audio=""
	map="-map 0:v:0"
	IFSs=$IFS
	IFS=,
	is=0
	for i in $answer
	do
	    #audio="$audio ${au[$i-1]}"
	    audio="$audio -c:a:$is ${ac[$i-1]}"
	    if [ "${ab[$i-1]}" != "" ]
	    then
		audio="$audio -b:a:$is ${ab[$i-1]}"
	    fi
	    lang=${al[$i-1]}
	    if [ "$lang" != "" ]
	    then
		if [ "$v" ">" "1.2.0" ]
		then
		    #l="-metadata:s:a:$is language=$lang"
		    audio="$audio $lang"
		fi
	    fi
	    map="$map -map 0:a:$(($i-1))"
	    is=$(($is+1))
	    echo ${aline[$i-1]}
	done
	IFS=$IFSs
	#audio="$audio -copyts"
	echo "map:" $map
	echo "audio:" $audio
	echo "Reihenfolge der Audiostreams Ã¼berprÃ¼fen"
	echo "n = Abbruch"
	read answer
	if [ "$answer" == "n" ]
	then
    	    exit
	fi
    fi

fi

#audio="$audio -async 1"
#if [ "$v" "<" "2.0.0" ]
#then
    audio="$audio $timestamps"
#fi
#exit

if [ "$subtitle" == "yes" ]
then

grep "Stream" $t | grep "Subtitle" > $t2

# Stream #0:5[0xe7](deu): Subtitle: dvb_subtitle ([6][0][0][0] / 0x0006) (hearing impaired)

#while read line
#do
    #echo $line
    #stream1=$(echo $line | cut -d ' ' -f 2 | cut -d ':' -f 2 | cut -d '[' -f 1)
    #map="$map -map 0:$stream1"
    #map="$map -map 0:s:0"
    map="$map -map 0:s?"
    #if [ "$mkv" == "yes" ]
    if [ "$outf" == "mkv" ]
    then
	#sub="-c:s srt"
	sub="-c:s dvd_subtitle"
    else
	sub="-c:s copy"
    fi
    #leave
#done < $t2

fi

echo "map:" $map >> $log
echo "audio:" $audio >> $log
echo "video:" $video >> $log

#service="-metadata service_name=\"$title\""
service="-metadata title=\"$title\""
ffopt="$metaf $map $video $audio $sub $filter $test $service"

}

#if [ "$join3" != "yes" ]
if [ "$join" != "projectx" ]
then
    file_check $infile
fi

#exit

#gopt="-n"
#gopt="$probesize $deinterlace"
#gopt="$probesize -drc_scale 0"
gopt="$gopt $probesize"
#gopt="$gopt -report"

#if [ "$join" == "yes" ]
if [ "$join" == "ffmpeg" ]
then
    #flist=/tmp/flist
    flist=flist
    rm -f $flist
    #filesj="-i concat:\""
fi
if [ "$join" == "concat" ]
then
    #filesj="-i concat:\""
    filesj="-i concat:"
    #filesj="concat:\""
fi

ges=0

for r in $w
do
    #files="$files -i $r"
    files="-i $r"
    $ffmpeg $form $files 2> $t
    # Duration: 00:17:26.08, start: 1.400000, bitrate: 1253 kb/s
    #set -x
    dur=$(grep "Duration:" $t)
    echo $dur >> $log
    dur2=$(echo $dur | cut -d ' ' -f2)
    dur2=$(echo $dur2 | cut -d '.' -f1)
    dur3=$(date +"%s" -d $dur2)
    b=$(date +"%s" -d "00:00:00")
    dur=$(($dur3-$b))
    ges=$(($ges+$dur))
    case $join in
	ffmpeg)
	    if [ -h $r ]
	    then
		rr=$(realpath $r)
		echo "file '$rr'" >> $flist
	    else
		echo "file '$r'" >> $flist
	    fi
	    ;;
	concat)
	    #filesj="$filesj$r\\|"
	    filesj="$filesj$r|"
	    ;;
	cat)
	    #if [ "$join2" == "yes" ]
	    #then
	    #nice cat $r >> $filej2
	    if [ "$fmt" == "vdr" ]
	    then
		filesj2="$filesj2 $r"
	    fi
	    if [ "$fmt" == "ts" ]
	    then
		if [ "$join2m" == "yes" ]
		then
		    if [ "$join2p" == "yes" ]
		    then
			filesj2="$filesj2 $r"
		    else
			f2=../${r:0:5}".mpg"
			#ffmpeg -i $r -map 0 -c copy $sub $f2
			#ffmpeg -i $r -map 0 -c copy -copyts $f2
			#ffmpeg -i $r -map 0 -c copy $f2
			$ffmpeg -i $r -map 0 -c copy -async 1 $f2
			filesj2="$filesj2 $f2"
		    fi
		    #form="-f mpeg"
		else
		    filesj2="$filesj2 $r"
		    form="-f mpegts"
		fi
	    fi
	    ;;
	projectx)
	    filesj3="$filesj3 $r"
	    ;;
	mplayer)
	    filesj4="$filesj4 $r"
	    ;;
	tsmuxer)
	    if [ "$filesjt" == "" ]
	    then
		filesjt="\"$r\""
	    else
		filesjt="$filesjt+\"$r\""
	    fi
	    ;;
	*)
	    o=$r
	    if [ "$fmt" == "vdr" ]
	    then
		o="00"$(basename $r .vdr).ts
	    fi
	    #if [ "$mkv" == "yes" ]
	    if [ "$outf" != "" ]
	    then
		#o=$title-$(basename $r .vdr).mkv
		o=$title-$(echo $r | cut -d '.' -f 1).$outf
		if [ "$fname" != "" ]
		then
		    o=$fname.$outf
		fi
	    fi
	    ofile=../$dest/$o
	    if [ "$odir" != "" ]
	    then
		ofile=$odir/$o
	    fi
	    opt="$gopt $form $files $ffopt $ofile"
	    echo $ffmpeg $opt >> $log
	    nice $ffmpeg $opt
	    #nice ffmpeg $opt 2>&1 | tee > $logf
	    $ffmpeg -i $o2 2> $t
	    grep "Duration:" $t >> $log
	    ;;
    esac
    done

if [ "$join" == "ffmpeg" ]
then
    h=$(($ges/3600))
    m=$(($ges/60-$h*60))
    s=$(($ges-$m*60-$h*3600))
    echo "Dauer $h:$m:$s" >> $log
    date -u -d @$ges "+%T" >> $log
    #echo $(($ges / 60)) "Minuten Dauer" >> $log
    cat $flist >> $log
    filesj=" -f concat -i $flist"
    #filesj=${filesj:0:$((${#filesj}-1))}"\""
    $ffmpeg $filesj 2> $t
    grep "Duration:" $t >> $log
    ofile="../$dest/00001.ts"
    if [ "$split" != "" ]
    then
	ofile="../$dest/0000%d.ts"
    fi
    #if [ "$mkv" == "yes" ]
    if [ "$outf" != "" ]
    then
	ofile="../$title.$outf"
	if [ "$odir" != "" ]
	then
	    ofile="$odir/$title.$outf"
	fi
    fi
    opt="$gopt $form $filesj $split $ffopt $ofile"
    echo $ffmpeg $opt >> $log
    nice $ffmpeg $opt
    #nice ffmpeg $opt 2>&1 | tee > $logf
    $ffmpeg -i $ofile 2> $t
    grep "Duration:" $t >> $log
fi
if [ "$join" == "concat" ]
then
    h=$(($ges/3600))
    m=$(($ges/60-$h*60))
    s=$(($ges-$m*60-$h*3600))
    echo "Dauer $h:$m:$s" >> $log
    date -u -d @$ges "+%T" >> $log
    #echo $(($ges / 60)) "Minuten Dauer" >> $log
    #filesj=${filesj:0:$((${#filesj}-2))}"\""
    filesj=${filesj:0:$((${#filesj}-1))}
    $ffmpeg $filesj 2> $t
    grep "Duration:" $t >> $log
    ofile="../$dest/00001.ts"
    if [ "$split" != "" ]
    then
	ofile="../$dest/0000%d.ts"
    fi
    #if [ "$mkv" == "yes" ]
    if [ "$outf" != "" ]
    then
	ofile="../$title.$outf"
	if [ "$odir" != "" ]
	then
	    ofile="$odir/$title.$outf"
	fi
    fi
    opt="$gopt $form $filesj $split $ffopt $ofile"
    echo $ffmpeg $opt >> $log
    nice $ffmpeg $opt
    #nice ffmpeg $opt 2>&1 | tee > $logf
    $ffmpeg -i $ofile 2> $t
    grep "Duration:" $t >> $log
fi
#if [ "$join2" == "yes" ]
if [ "$join" == "cat" ]
then
    h=$(($ges/3600))
    m=$(($ges/60-$h*60))
    s=$(($ges-$m*60-$h*3600))
    echo "Dauer $h:$m:$s" >> $log
    #nice cat $filesj2 > $filej2
    #filej22=filej2.mpg
    #mencoder -of mpeg -forceidx -oac copy -ovc copy "$filej2" -o "$filej22"
    #ffmpeg -i $filej2 2>> $log
    ofile="../$dest/00001.ts"
    #if [ "$mkv" == "yes" ]
    if [ "$outf" != "" ]
    then
	ofile="../$title.$outf"
	if [ "$odir" != "" ]
	then
	    ofile="$odir/$title.$outf"
	fi
    fi
    #opt="$gopt -i $filej2 $ffopt $ofile"
    opt="$gopt $form -i - $ffopt $ofile"
    echo $ffmpeg $opt >> $log
    #nice ffmpeg $opt
    if [ "$join2p" == "yes" ]
    then
	for i in $filesj2
	do
	    o=/run/${i:0:5}.mpg
	    rm -f $o
	    mkfifo $o
	    #exec="$exec ffmpeg -i $i -map 0 -c copy -copyts $o &"
	    #ffmpeg -i $i -map 0 -c copy -copyts -y $o &
	    #ffmpeg -i $i -map 0 -c copy -y $o 2> /dev/null &
	    $ffmpeg $form -i $i -map 0 -c copy -async 1 -y $o 2> /dev/null &
	    filesj22="$filesj22 $o"
	done
	cat $filesj22 | nice $ffmpeg $opt
	killall $ffmpeg
    else
	cat $filesj2 | nice $ffmpeg $opt
	#cat $filesj2 | nice ffmpeg $opt 2>&1 | tee > $logf
	#rm -f $filej2
	#rm -f $filej22
	if [ "$fmt" == "ts" ]
	then
	    if [ "$join2m" == "yes" ]
	    then
		rm -i $filesj2
	    fi
	fi
    fi
    $ffmpeg -i $ofile 2> $t
    grep "Duration:" $t >> $log
fi
#if [ "$join3" == "yes" ]
if [ "$join" == "projectx" ]
then
    h=$(($ges/3600))
    m=$(($ges/60-$h*60))
    s=$(($ges-$m*60-$h*3600))
    echo "Dauer $h:$m:$s" >> $log
    date -u -d @$ges "+%T" >> $log
    mkdir -p $temp
    rm -f $temp/*.m1v
    rm -f $temp/*.m2v
    rm -f $temp/*.264
    rm -f $temp/*.mp2
    rm -f $temp/*.ac3
    rm -f $temp/*.aac
    rm -f $temp/*.wav
    rm -f $temp/temp.ts
    rm -f $temp/*.txt
    temps=$(du $temp)
    temps=$(echo $temps | cut -d \  -f 1)
    echo "temps=$temps size1=$size1" >> $log
    ofile="../$dest/00001.ts"
    if [ "$split" != "" ]
    then
	ofile="../$dest/0000%d.ts"
    fi
    #if [ "$mkv" == "yes" ]
    if [ "$outf" != "" ]
    then
	ofile="../$title.$outf"
	if [ "$odir" != "" ]
	then
	    ofile="$odir/$title.$outf"
	fi
    fi
    if [ "$projectxd" == "yes" ]
    then
	if [ "$demux_x264" == "yes" -a "$demux_aac" == "yes" ]
	then
	    direct=yes
	fi
	nice projectx -demux -out $temp $filesj3
	plog=$(ls $temp/*.txt)
	cat $plog >> $log
	echo .
	ls -l $temp >> $log
	#set -x
	case $fmt in
	    "ts")
		n="00001"
		;;
	    "vdr")
		n="001"
		;;
	esac
	declare -a mp2name
	mp2name[0]=$n".mp2"
	mp2name[1]=$n"-02.mp2"
	mp2name[2]=$n"-03.mp2"
	mp2name[3]=$n"-04.mp2"
	declare -a langa
	grep "PID:" $plog > $t2
	im=0
	while read line
	do
	    echo $line
	    kenn=$(echo $line | cut -d ' ' -f 2 | cut -d '{' -f 1)
	    lang=$(echo $line | cut -d '{' -f 2 | cut -d '}' -f 1)
	    typ=$(echo $line | cut -d \( -f 2 | cut -d \) -f 1)
	    if [ "$typ" == "Mpg1" ]
	    then
		langa[$kenn]=$lang
		#mv $temp/${mp2name[$im]} $temp/$kenn-$lang.mp2
		#im=$(($im+1))
	    fi
	    if [ "$typ" == "AC-3" ]
	    then
		kenn=$(echo $line | cut -d ' ' -f 2 | cut -d '(' -f 1)
		langa[$kenn]=$lang
		#mv $temp/00001.ac3 $temp/$kenn-$lang.ac3
	    fi
	done < $t2
	#grep "\"ok> PID\"" $plog > $t2
	grep "ok> PID" $plog > $t2
	#grep "has PES-ID" $plog > $t2
	im=0
	while read line
	do
	    echo $line
	    kenn=$(echo $line | cut -d ' ' -f 3)
	    typ=$(echo $line | cut -d ' ' -f 7-8)
	    if [ "$typ" == "(MPEG Audio)" ]
	    then
		lang=${langa[$kenn]}
		msg=${mp2name[$im]}" -> "$kenn-$lang.mp2
		echo $msg | tee >> $log
		mv $temp/${mp2name[$im]} $temp/$kenn-$lang.mp2
		im=$(($im+1))
	    fi
	    if [ "$typ" == "(private stream" ]
	    then
		lang=${langa[$kenn]}
		mv $temp/$n.ac3 $temp/$kenn-$lang.ac3
		#im=$(($im+1))
	    fi
	done < $t2
	grep "found PES-ID" $plog > $t2
	# -> found PES-ID 0xC0 (MPEG Audio) @ 81845
	im=0
	while read line
	do
	    echo $line
	    kenn=$(echo $line | cut -d ' ' -f 4)
	    typ=$(echo $line | cut -d ' ' -f 5-6)
	    if [ "$typ" == "(MPEG Audio)" ]
	    then
		langa[$kenn]=deu
		msg=${mp2name[$im]}" -> "$kenn-deu.mp2
		echo $msg | tee >> $log
		mv $temp/${mp2name[$im]} $temp/$kenn-deu.mp2
		im=$(($im+1))
	    fi
	    if [ "$typ" == "(private stream" ]
	    then
		langa[$kenn]=deu
		mv $temp/$n.ac3 $temp/$kenn-deu.ac3
	    fi
	done < $t2
	ls -l $temp >> $log
	#exit
	meta=$temp/vdr.meta
	#rm -f $meta
	#set -x
	echo "MUXOPT --no-pcr-on-video-pid --new-audio-pes --vbr  --vbv-len=500" > $meta
	map="-map 0:v:0"
	fmp2=$(ls $temp/*.mp2)
	f2mp2=""
	is=1
	#set -x
	rm -f $t2
	audio=""
	for i in $fmp2
	do
	    map="$map -map $is:a:0"
	    lang=$(echo $i | cut -d '-' -f 2 | cut -d '.' -f 1)
	    if [ "$mux" == "ffmpeg" ]
	    then
		f2mp2="$f2mp2 -i $i"
		# 001.mp2: MPEG ADTS, layer II, v1, 192 kbps, 48 kHz, Stereo
		l=$(file $i)
		bra=$(echo $l | cut -d \  -f 7)
		aac_br $bra
		#echo $br
		if [ "$fmt" == "ts" ]
		then
		    l="-metadata:s:a:$(($is-1)) language=$lang"
		else
		    l=""
		fi
		a="-c:a:$(($is-1)) $aaclib -b:a:$(($is-1)) "$br"k $l"
		if [ "$mp2_256" == "ac3" -a $bra -ge 256 ]
		then
		    #a="-c:a:$(($is-1)) ac3 -ac 2 -b:a:$(($is-1)) 192k $l"
		    a="-c:a:$(($is-1)) ac3 -ac:a:$(($is-1)) 2 -b:a:$(($is-1)) 192k $l"
		fi
		if [ "$mp2_256_no_ac3" == "ac3" -a $bra -ge 256 -a "$ac3_vorh" == "" ]
		then
		    #a="-c:a:$(($is-1)) ac3 -ac 2 -b:a:$(($is-1)) 192k $l"
		    a="-c:a:$(($is-1)) ac3 -ac:a:$(($is-1)) 2 -b:a:$(($is-1)) 192k $l"
		fi
		audio="$audio $a"
	    fi
	    is=$(($is+1))
	    if [ "$demux_aac" == "yes" ]
	    then
		aac_encode=$aaclib
		#aac_encode=nero
		# 001.mp2: MPEG ADTS, layer II, v1, 192 kbps, 48 kHz, Stereo
		l=$(file $i)
		bra=$(echo $l | cut -d \  -f 7)
		aac_br $bra
		#echo $br
		out=${i%.*}.aac
		#neroAacEnc -cbr 128 -if $i -of $out
		if [ "$aac_encode" == "$aaclib" ]
		then
		    ffmp2opt="-i $i -c:a:0 $aaclib -b:a:0 $br"k" $timestamps $out"
		    echo $ffmpeg $ffmp2opt >> $log
		    nice $ffmpeg $ffmp2opt &
		    FPID="$FPID $!"
		fi
		if [ "$aac_encode" == "nero" ]
		then
		    wav=$temp/temp.wav
		    #mkfifo $wav
		    #ffmpeg -i $i -copyts -y $wav &
		    $ffmpeg -i $i $timestamps $wav
		    nbr=$(($br*1000))
		    neroAacEnc -lc -cbr $nbr -if $wav -of $out
		fi
		echo "A_AAC, \"$out\", lang=$lang" >> $t2
	    else
		echo "A_MP3, \"$i\", lang=$lang" >> $t2
	    fi
	done
	fv=$(ls $temp/*.m2v $temp/*.m1v)
	if [ "$demux_x264" == "yes" ]
	then
	    # -> avg. nom. bitrate 3983947bps (min/max: 1883600/8063200)
	    bra=$(grep "avg. nom. bitrate" $plog | cut -d \  -f 5)
	    bra=${bra//bps/}
	    br=$((bra/2000))
	    if [ $br -gt 2000 ]
	    then
		br=2000
	    fi
	    out=$temp/$n.264
	    #deinterlace="-vf yadif"
	    deinterlace="--tff"
	    level="-level $h264_level"
	    opt="--preset fast --tune film --profile $h264_profile $level --crf $crf --vbv-bufsize 1835 --vbv-maxrate $br $deinterlace -I 50"
	    echo "x264: $opt" >> $log
	    x264 $opt -o $out $fv
	    #exit
	    echo "V_MPEG4/ISO/AVC, \"$out\", fps=25, insertSEI, contSPS" >> $meta
	else
	    echo "V_MPEG-2, \"$fv\", fps=25" >> $meta
	fi
	if [ "$FPID" != "" ]
	then
	    wait $FPID
	fi
	cat $t2 >> $meta
	#exit
	fac3=$(ls $temp/*.ac3)
	f2ac3=""
	for i in $fac3
	do
	    f2ac3="$f2ac3 -i $i"
	    lang=$(echo $i | cut -d '-' -f 2 | cut -d '.' -f 1)
	    #l=$(file $i)
	    #echo "ac3=$l" >> $log
	    $ffmpeg -i $i 2> $t2
	    #cat $t2 >> $log
	    l=$(cat $t2 | grep "Stream")
	    #echo "ac3=$l" >> $log
	    l=${l//,/}
	    atyp1=${l#*Hz*}
	    atyp=$(echo $atyp1 | cut -d ' ' -f 1)
	    atyp=${atyp//,/}
	    #echo "atyp=$atyp" >> $log
	    a="-c:a:$(($is-1)) copy"
	    if [ "$ac3_stereo" == "ac3" -a "$atyp" == "stereo" ]
	    then
		br=192
		#a="-c:a:$(($is-1)) ac3 -ac 2 -b:a:$(($is-1)) "$br"k"
		a="-c:a:$(($is-1)) ac3 -ac:a:$(($is-1)) 2 -b:a:$(($is-1)) "$br"k"
	    fi
	    map="$map -map $is:a:0"
	    #audio="$audio -c:a:$(($is-1)) copy"
	    audio="$audio $a"
	    is=$(($is+1))
	    echo "A_AC3, \"$i\", lang=$lang" >> $meta
	done
	#set -x
	if [ "$direct" == "yes" ]
	then
	    file=../$dest/00001.ts
	    #if [ "$mkv" == "yes" ]
	    if [ "$outf" != "" ]
	    then
		file=../$title.$outf
		mux=mkvmerge
	    fi
	else
	    file=$temp/temp.ts
	    #mkfifo $file
	fi
	#tsmuxer=yes
	#if [ "$tsmuxer" == "yes" ]
	#then
	case $mux in
	    tsmuxer)
		wlog "tsmuxer"
		#cat $meta >> $log
		nice tsMuxeR $meta $file
		cat $meta >> $auswahl_hilfe
		;;
	    mkvmerge)
		if [ "$mkv" != "yes" ]
		then
		    file=$temp/temp.mkv
		fi
		mkvmerge -o $file $fv $fmp2 $fac3 --timecode-scale -1
		;;
	    ffmpeg)
		#set -x
		direct=yes
		files="-i $fv $f2mp2 $f2ac3"
		if [ "$direct" == "yes" ]
		then
		    #if [ 0 -eq 1 ]
		    #then
		    #map="map 0:v:0"
		    if [ "$vcodec" == "h264" -o "$vcodec" == "" ]
		    then
		    #br=2000
		    bra=$(grep "avg. nom. bitrate" $plog | cut -d \  -f 5)
		    bra=${bra//bps/}
		    br=$((bra/2000))
		    if [ $br -gt 2000 ]
		    then
			br=2000
		    fi
		    if [ "$maxrate" != "no" ]
		    then
			maxr="-maxrate "$br"k -bufsize 1835k"
		    fi
		    preset="-preset fast -tune film -profile:v $h264_profile $level -crf $crf $maxr"
		    if [ $h264enc == "h264_nvenc" ]
		    then
		        #preset="-preset hq -profile:v $h264_profile -crf $crf $nvenc_b $maxr"
		        set_h264_nvenc
		    fi
		    preset="$preset $gop"
		    video="-c:v $h264enc $preset $deinterlace $scale"
		    fi
		    if [ "$vcodec" == "hevc" ]
		    then
			set_hevc
			#video="-c:v $hevcenc $preset $deinterlace $scale"
		    fi
		    #vcodec=H264
		    #if [ "$v" < "2.0.0" ]
		    #then
			audio="$audio $timestamps"
		    #fi
		    #fi
		    wlog "video: $video"
		    wlog "audio: $audio"
		    ffopt="$metaf $map $video $audio $service"
		    file="../$dest/00001.ts"
		    if [ "$split" != "" ]
		    then
			ofile="../$dest/0000%d.ts"
		    fi
		else
		    file=$temp/temp.mpg
		    #files="-r 1 -f mpeg -i $fv -r 25 $f2mp2 $f2ac3"
		    #files="-f rawvideo -i $fv $f2mp2 $f2ac3"
		    #files="-r 1 -f mpeg -i $fv -r 25 $f2mp2 $f2ac3"
		    #ffopt="-map 0 -c copy -fflags genpts"
		    #map="-map 0:v:0 -map 0:a:0"
		    ffopt="$metaf $map -c copy -fflags genpts"
		    # Ticket #1598 (open defect)
		fi
		opt="$files $ffopt $file"
		wlog "$ffmpeg $opt"
		#exit
		$ffmpeg $opt
		#ffmpeg $opt 2>&1 | tee > $logf
		;;
	esac
	#fi
	rm -f $temp/*.m1v
	rm -f $temp/*.m2v
	rm -f $temp/*.264
	rm -f $temp/*.mp2
	rm -f $temp/*.ac3
	rm -f $temp/*.aac
	rm -f $meta
	#grep "-> found" $plog >> $auswahl_hilfe
	#grep " found" $plog >> $auswahl_hilfe
	grep "PES-ID" $plog >> $auswahl_hilfe
	grep "PID:" $plog >> $auswahl_hilfe
	cat $auswahl_hilfe >> $log
	#exit
	if [ "$direct" == "yes" ]
	then
	    opt="$gopt -i $file"
	else
	    $ffmpeg -i $file 2>> $log
	    file_check $file
	    opt="$gopt -i $file $ffopt $ofile"
	fi
	#exit
    else
    #to=vdr
    case $fmt in
	"vdr")
	    to=m2p
	    ;;
	"ts")
	    to=ts
	    ;;
    esac
    to2=$to
    if [ "$to" == "m2p" ]
    then
	to2=mpg
    fi
    case $fmt in
	"vdr")
	    pfile="$temp/001[pes][remux].$to2"
	    plog="$temp/001_log.txt"
	;;
	"ts")
	    pfile="$temp/00001[remux].$to2"
	    plog="$temp/00001_log.txt"
	;;
    esac
    #mkfifo $pfile
    #nice projectx -tots -out temp $filesj3
    #nice projectx -to$to -out temp $filesj3 & > /dev/null
    #projectx -to$to -out temp $filesj3 &
    nice projectx -to$to -out $temp $filesj3
    #exit
    cat $plog >> $log
    $ffmpeg -i $pfile 2>> $log
    file_check $pfile
    #exit
    #opt="$gopt -i $file $ffopt $ofile"
    #if [ "$to" == "vdr" ]
    #then
	#form="-f mpeg"
    #fi
    opt="$gopt $form -i $pfile $ffopt $ofile"
    fi
    wlog "$ffmpeg $opt"
    #echo ffmpeg $opt >> $log
    nice $ffmpeg $opt
    rm -f $temp/temp.ts
    rm -f $temp/*.txt
    #ffmpeg -i $ofile 2> $t
    #grep "Duration:" $t >> $log
fi
#if [ "$join4" == "yes" ]
if [ "$join" == "mplayer" ]
then
    h=$(($ges/3600))
    m=$(($ges/60-$h*60))
    s=$(($ges-$m*60-$h*3600))
    echo "Dauer $h:$m:$s" >> $log
    ofile="../$dest/00001.ts"
    #if [ "$mkv" == "yes" ]
    if [ "$outf" != "" ]
    then
	ofile="../$title.$outf"
    fi
    #mkdir temp
    #nice mplayer -dumpstream $filesj4
    nice mplayer -dumpstream 0000*.ts
    exit
    if [ "$fmt" == "vdr" ]
    then
	file="$temp/001[pes][remux].ts"
	cat $temp/001_log.txt >> $log
    fi
    if [ "$fmt" == "ts" ]
    then
	file="$temp/00001[remux].ts"
	cat $temp/00001_log.txt >> $log
    fi
    $ffmpeg -i $file 2>> $log
    #exit
    opt="$gopt -i $file $ffopt $ofile"
    echo $ffmpeg $opt >> $log
    nice $ffmpeg $opt
    $ffmpeg -i $ofile 2> $t
    grep "Duration:" $t >> $log
fi
#if [ "$join5" == "yes" ]
if [ "$join" == "mkvmerge" ]
then
    h=$(($ges/3600))
    m=$(($ges/60-$h*60))
    s=$(($ges-$m*60-$h*3600))
    echo "Dauer $h:$m:$s" >> $log
    ofile="../$dest/00001.ts"
    files=$(ls $w)
    file=$temp/temp.mkv
    mkvmerge -o $file $files --timecode-scale -1
    opt="$gopt -i $file $ffopt $ofile"
    echo $ffmpeg $opt >> $log
    nice $ffmpeg $opt
    $ffmpeg -i $ofile 2> $t
    grep "Duration:" $t >> $log
fi
if [ "$join" == "tsmuxer" ]
then
    h=$(($ges/3600))
    m=$(($ges/60-$h*60))
    s=$(($ges-$m*60-$h*3600))
    echo "Dauer $h:$m:$s" >> $log
    #set -x
    mkdir -p $temp
    if [ "$v" "<" "1.2.0" -o "$ffmpeg" == "avconv" ]
    then
    #$ffprobe -i $infile -show_streams > $t
    $ffprobe $infile -show_streams > $t
    while read line
    do
	k=$(echo $line | cut -d "=" -f 1)
	case $k in
	    "index")
		is=$(echo $line | cut -d "=" -f 2)
		;;
	    "start_time")
		startar[$is]=$(echo $line | cut -d "=" -f 2)
		;;
	esac
    done < $t
    #echo ${start[0]}
    #exit
    startv=${startar[0]}
    else
	#startv=$($ffprobe -i $infile -show_streams -select_streams v | grep "start_time=" | cut -d "=" -f 2)
	startv=$($ffprobe $infile -show_streams -select_streams v | grep "start_time=" | cut -d "=" -f 2)
    fi
    startv=${startv//./}
    l=${#startv}
    startv=${startv:0:$(($l-3))}
    file="$temp/temp.ts"
    meta=$temp/vdr.meta
    echo "MUXOPT --no-pcr-on-video-pid --new-audio-pes --vbr  --vbv-len=500" > $meta
    #$ffprobe -i $infile 2> $t
    $ffprobe $infile 2> $t
    grep "Stream" $t > $t2
    # Stream #0:0[0xa3]: Video: mpeg2video (Main) ([2][0][0][0] / 0x0002), yuv420p, 720x576 [SAR 64:45 DAR 16:9], 25 fps, 25 tbr, 90k tbn, 50 tbc
    # Stream #0:1[0x68](deu): Audio: mp2 ([3][0][0][0] / 0x0003), 48000 Hz, stereo, s16p, 192 kb/s (clean effects)
    # Stream #0:2[0x6a](deu): Audio: ac3 ([6][0][0][0] / 0x0006), 48000 Hz, stereo, fltp, 384 kb/s (clean effects)
    # Stream #0:3[0x6e](deu): Subtitle: dvb_subtitle ([6][0][0][0] / 0x0006)
    #
    # Stream #0:0[0x1e0]: Video: mpeg2video (Main), yuv420p, 720x576 [SAR 16:15 DAR 4:3], 25 fps, 25 tbr, 90k tbn, 50 tbc
    # Stream #0:1[0x1c0]: Audio: mp2, 48000 Hz, stereo, s16p, 192 kb/s
    ia=0
    while read line
    do
	echo $line
	typ=$(echo $line | cut -d \  -f 4)
	typ=${typ//,/}
	kenn=$(echo $line | cut -d "["  -f 2 | cut -d "]"  -f 1)
	kenn=$(($kenn))
	case $typ in
	    "mpeg2video" | "mpeg1video")
		m="V_MPEG-2, $filesjt, fps=25, track=$kenn"
		echo $m
		echo $m >> $meta
		;;
	    "h264")
		m="V_MPEG4/ISO/AVC, $filesjt, fps=25, track=$kenn"
		echo $m
		echo $m >> $meta
		;;
	    "ac3")
		if [ "$v" "<" "1.2.0" -o "$ffmpeg" == "avconv" ]
		then
		    starta=${startar[$(($ia+1))]}
		else
		    #starta=$($ffprobe -i $infile -show_streams -select_streams a:$ia | grep "start_time=" | cut -d "=" -f 2)
		    starta=$($ffprobe $infile -show_streams -select_streams a:$ia | grep "start_time=" | cut -d "=" -f 2)
		fi
		starta=${starta//./}
		l=${#starta}
		starta=${starta:0:$(($l-3))}
		if [ $starta -ge $startv ]
		then
		    tsh=$(($starta-$startv))
		else
		    tsh="-"$(($startv-$starta))
		fi
		lang=$(echo $line | cut -d "("  -f 2 | cut -d ")"  -f 1)
		m="A_AC3, $filesjt, timeshift="$tsh"ms, track=$kenn, lang=$lang"
		echo $m
		echo $m >> $meta
		ia=$(($ia+1))
		;;
	    "mp2" | "aac")
		if [ "$v" "<" "1.2.0" -o "$ffmpeg" == "avconv" ]
		then
		    starta=${startar[$(($ia+1))]}
		else
		    #starta=$($ffprobe -i $infile -show_streams -select_streams a:$ia | grep "start_time=" | cut -d "=" -f 2)
		    starta=$($ffprobe $infile -show_streams -select_streams a:$ia | grep "start_time=" | cut -d "=" -f 2)
		fi
		starta=${starta//./}
		l=${#starta}
		starta=${starta:0:$(($l-3))}
		if [ $starta -ge $startv ]
		then
		    tsh=$(($starta-$startv))
		else
		    tsh="-"$(($startv-$starta))
		fi
		lang=$(echo $line | cut -d "("  -f 2 | cut -d ")"  -f 1)
		if [ "$typ" == "mp2" ]
		then
		    typ2="MP3"
		fi
		if [ "$typ" == "aac" ]
		then
		    typ2="AAC"
		fi
		m="A_$typ2, $filesjt, timeshift="$tsh"ms, track=$kenn, lang=$lang"
		echo $m
		echo $m >> $meta
		ia=$(($ia+1))
		;;
	esac
    done < $t2
    cat $meta >> $log
    #exit
    rm -f $file
    nice tsMuxeR $meta $file
    file_check $file
    cat $t >> $log
    ofile="../$dest/00001.ts"
    if [ "$split" != "" ]
    then
	ofile="../$dest/0000%d.ts"
    fi
    #if [ "$mkv" == "yes" ]
    if [ "$outf" != "" ]
    then
	ofile="../$title.$outf"
	if [ "$odir" != "" ]
	then
	    ofile="$odir/$title.mkv"
	fi
    fi
    #opt="$gopt -i $filej2 $ffopt $ofile"
    opt="$gopt $form -i $file $split $ffopt $ofile"
    #echo ffmpeg $opt >> $log
    wlog "$ffmpeg $opt"
    nice $ffmpeg $opt
    rm -f $file
    rm -f $meta
fi

#ffmpeg -i 0000%d.ts
#ffmpeg -n -i 00001.ts -c:v libx264 -c:a copy $test ../$dest/00001.ts

#if [ "$mkv" != "yes" ]
if [ "$outf" == "" ]
then

cp -p $info ../$dest/info
if [ "$fmt" == "vdr" ]
then
    echo "L 99" >> ../$dest/info
fi

if [ "$vcodec" != "mpeg2video" ]
then
if [ -e info.txt ]
then
    i=$(cat info.txt)
    echo "$i $vcodec" > ../$dest/info.txt
else
    echo $vcodec > ../$dest/info.txt
fi
fi

if [ -e logfile ]
then
    cp -p logfile ../$dest/logfile1
fi
if [ -e logfile1 ]
then
    fd=$(date -r logfile1 "+%Y%m%d%H%M")
    cp -p logfile1 ../$dest/logfile".$fd"
fi

#set -x
#cd ../$dest

if [ -e $vdr ]
then
    wd=$(pwd)
    #$vdr --genindex="$wd"
    $vdr --genindex="../$dest"
fi

#ffmpeg -i 00001.ts 2>> $log

if [ -e $videodir ]
then
    /usr/bin/touch $videodir/.update
fi

fi
if [ "$fname" != "" -a "$odir" != "" ]
then
    cp -p $info $odir/info
fi

# [libx264 @ 0x955ec00] using cpu capabilities: MMX2 SSE2Fast SSSE3 SSE4.2 AVX XOP FMA4 FMA3 LZCNT BMI1
if [ -e h264.err ]
then
    #grep "using cpu capabilities" h264.err >> $log
    grep "\[libx264" h264.err >> $log
    grep "x265 \[" h264.err >> $log
    grep "decoding errors" h264.err >> $log
fi

o=../$dest/00001.ts
#if [ "$mkv" != "" ]
if [ "$outf" != "" ]
then
    o=$ofile
    touch -d @$rec_time $o
fi
$ffmpeg -i $o 2>> $log

#d=`date +"%F %T"`
#echo "Ende $d" >> $log
wlog "Ende"
ende=$(date +"%s")
sek=$(($ende-$start))
min=$(($sek/60))
echo "$min Minuten" >> $log
#size2=$(du)
#if [ "$mkv" == "yes" ]
if [ "$outf" != "" ]
then
    size2=$(ls -lk $ofile | cut -d \  -f 5)
    size2=$(($size2/1024))
else
    size2=$(du ../$dest)
    size2=$(echo $size2 | cut -d ' ' -f 1)
fi
comp=$(($size1*100/$size2))
echo "vorher " $size1  >> $log
echo "nachher" $size2  >> $log
echo "Kompression: $comp %" >> $log
if [ -e $h264_k ]
then
    mv $h264_k h264.rdy
    rm $lock
fi
